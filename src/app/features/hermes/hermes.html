<div class="flex h-full flex-1 flex-col bg-gnome-bg p-6">
  <div #scrollFrame class="flex-1 overflow-y-auto mb-4 pr-4 space-y-4 custom-scrollbar">
    @if (messages().length === 0) {
      <div class="flex flex-col items-center justify-center h-full text-center opacity-80">
        <h1 class="text-[#00916E] font-bold text-3xl mb-2">{{ lang.t().hermes.welcome }}</h1>
        <p class="text-sm text-gnome-text-secondary">{{ lang.t().hermes.desc }}</p>
      </div>
    }

    @for (msg of messages(); track $index) {
      <div class="flex flex-col" [ngClass]="msg.role === 'user' ? 'items-end' : 'items-start'">
        <div
          [ngClass]="
            msg.role === 'user'
              ? 'bg-[#00916E] text-white rounded-l-2xl rounded-tr-2xl'
              : 'bg-gnome-surface border border-gnome-border text-gnome-text rounded-r-2xl rounded-tl-2xl'
          "
          class="max-w-[85%] p-1.5 shadow-sm text-sm overflow-hidden"
        >
          @if (msg.image) {
            <img [src]="msg.image" class="w-full max-h-80 object-cover rounded-xl" />
          }

          @if (msg.text) {
            <div class="p-2 leading-relaxed" [innerHTML]="msg.text | markdown"></div>
          }
        </div>
      </div>
    }

    @if (isLoading()) {
      <div class="flex justify-start">
        <div class="bg-gnome-surface p-3 rounded-2xl animate-pulse flex items-center gap-2">
          <div class="w-2 h-2 bg-[#00916E] rounded-full animate-bounce"></div>
          <span class="text-xs italic text-gnome-text-secondary">Hermes...</span>
        </div>
      </div>
    }
  </div>

  <div class="relative w-full max-w-2xl mx-auto">
    @if (previewUrl()) {
      <div class="absolute -top-28 left-0 z-20 animate-in zoom-in-95 duration-200">
        <div class="relative p-1 bg-gnome-surface border border-gnome-border rounded-xl shadow-2xl">
          <img [src]="previewUrl()" class="h-24 w-24 object-cover rounded-lg shadow-inner" />
          <button
            (click)="clearAttachment()"
            class="absolute -top-2 cursor-pointer -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px] hover:bg-red-600 shadow-md transition-all active:scale-90"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    }

    <div class="relative flex items-center">
      <label
        class="absolute left-4 cursor-pointer text-gnome-text-secondary hover:text-[#00916E] transition-colors z-10"
      >
        <i class="fas fa-image text-lg" [class.text-[#00916E]]="selectedFile()"></i>
        <input type="file" class="hidden" (change)="onFileSelected($event)" accept="image/*" />
      </label>

      <input
        type="text"
        [(ngModel)]="userInput"
        (keyup.enter)="handleSendMessage()"
        [placeholder]="lang.t().hermes.ask"
        class="w-full p-4 pl-12 pr-12 rounded-2xl border outline-none transition-all duration-300 bg-gnome-surface border-gnome-border text-gnome-text focus:border-[#00916E] focus:ring-4 focus:ring-[#00916E]/15 shadow-lg"
      />

      <button
        (click)="handleSendMessage()"
        [disabled]="isButtonDisabled()"
        class="absolute right-4 text-[#00916E] cursor-pointer disabled:opacity-30 enabled:hover:scale-110 transition-transform active:scale-95"
      >
        <i [class]="isLoading() ? 'fas fa-spinner fa-spin' : 'fas fa-feather-pointed'"></i>
      </button>
    </div>
  </div>
</div>
